<div class="card fade-in">
  <p-toast></p-toast>

  <h2 class="text-2xl font-bold mb-4 text-gray-800">
    Busca de Produtos em Lote
  </h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <!-- Upload Section -->
    <p-card header="1. Carregar Arquivos" styleClass="h-full">
      <p class="mb-4 text-gray-600">
        Selecione arquivos XML ou um arquivo ZIP contendo as notas.
      </p>
      <p-fileUpload #fileUpload mode="advanced" chooseLabel="Selecionar" uploadLabel="Carregar" cancelLabel="Limpar"
        [customUpload]="true" (uploadHandler)="onSelectFiles($event)" [multiple]="true" accept=".xml,.zip"
        [maxFileSize]="50000000" [showUploadButton]="false" [showCancelButton]="false">
        <!-- Custom Header -->
        <ng-template pTemplate="header" let-files let-chooseCallback="chooseCallback" let-clearCallback="clearCallback"
          let-uploadCallback="uploadCallback">
          <div class="flex flex-wrap justify-center gap-4 py-4 border-b border-surface-200 dark:border-surface-700">
            <p-button (onClick)="chooseCallback()" icon="pi pi-plus" label="Escolher" [outlined]="true"
              [disabled]="isProcessing"></p-button>
            <p-button (onClick)="uploadCallback()" icon="pi pi-cloud-upload" label="Carregar" severity="success"
              [disabled]="!files || files.length === 0 || isProcessing"></p-button>
            <p-button (onClick)="clearCallback(); clear()" icon="pi pi-times" label="Limpar" severity="danger"
              [outlined]="true" [disabled]="(!files || files.length === 0) && totalFilesLoaded === 0"></p-button>
          </div>
        </ng-template>

        <ng-template pTemplate="content">
          <!-- State 1: Processing -->
          <div *ngIf="isProcessing" class="flex flex-col items-center justify-center p-8">
            <p-knob [(ngModel)]="progress" [readonly]="true" [size]="150" valueColor="#5d8a8c"
              rangeColor="#f3e4c9"></p-knob>
            <span class="text-primary font-semibold text-lg mt-4">Processando arquivos...</span>
          </div>

          <!-- State 2: Files Loaded (Summary) -->
          <div *ngIf="!isProcessing && fileUpload.files.length > 0" class="flex flex-col gap-4 p-4">
            <div
              class="flex flex-col sm:flex-row items-center justify-between p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800 gap-4">
              <div class="flex items-center gap-3">
                <i class="pi pi-check-circle text-3xl text-green-600"></i>
                <div class="flex flex-col text-left">
                  <span class="font-bold text-xl text-green-900 dark:text-green-50">{{ fileUpload.files.length }}
                    arquivos selecionados</span>
                  <span class="text-sm text-green-700 dark:text-green-200">Pronto para carregar</span>
                </div>
              </div>

              <p-button [label]="showFileList ? 'Ocultar' : 'Ver Arquivos'"
                [icon]="showFileList ? 'pi pi-eye-slash' : 'pi pi-eye'" [outlined]="true" severity="success"
                (onClick)="toggleFileList()">
              </p-button>
            </div>

            <!-- File List (Scroller) -->
            <div *ngIf="showFileList" class="w-full animation-fade-in mt-4">
              <!-- Search Bar -->
              <div class="flex justify-center mb-2">
                <p-iconField iconPosition="left" class="w-full">
                  <p-inputIcon styleClass="pi pi-search" />
                  <input type="text" pInputText placeholder="Pesquisar arquivo..." [(ngModel)]="fileSearchTerm"
                    class="w-full" />
                </p-iconField>
              </div>

              <p-scroller [items]="filteredFiles" [itemSize]="50" scrollHeight="200px"
                styleClass="border surface-border rounded-lg bg-surface-50" [style]="{'width': '100%'}">
                <ng-template pTemplate="item" let-file let-options="options">
                  <div
                    class="flex items-center justify-between p-2 border-b surface-border h-[50px] px-4 hover:bg-surface-100 cursor-default">
                    <div class="flex items-center gap-2 overflow-hidden">
                      <i class="pi pi-file text-primary"></i>
                      <span class="truncate text-sm" [innerHTML]="file.name | highlight: fileSearchTerm"></span>
                      <span class="text-xs text-gray-500 whitespace-nowrap">({{ fileUpload.formatSize(file.size)
                        }})</span>
                    </div>
                    <p-button icon="pi pi-times" [text]="true" [rounded]="true" severity="danger"
                      (onClick)="removeFile($event, file)"></p-button>
                  </div>
                </ng-template>
              </p-scroller>
            </div>
          </div>

          <!-- State 3: Empty (Drag & Drop) -->
          <div *ngIf="!isProcessing && fileUpload.files.length === 0"
            class="flex flex-col items-center justify-center py-10 text-center cursor-pointer"
            (click)="fileUpload.choose()">
            <i class="pi pi-cloud-upload text-6xl text-primary mb-4 opacity-50"></i>
            <p class="text-lg font-semibold text-gray-600">Arraste e solte arquivos aqui ou clique para selecionar</p>
            <p class="text-sm text-gray-500 mt-2">Suporta .xml e .zip</p>
          </div>
        </ng-template>
      </p-fileUpload>

      <div *ngIf="totalFilesLoaded > 0 && !isProcessing"
        class="mt-4 p-3 bg-blue-100 border border-blue-300 rounded text-blue-700">
        <i class="pi pi-database mr-2"></i>
        <strong>{{ totalFilesLoaded }}</strong> arquivos já carregados em memória e prontos para busca.
      </div>
    </p-card>

    <!-- Search Section -->
    <p-card header="2. Buscar Produto" styleClass="h-full">
      <p class="mb-4 text-gray-600">
        Digite parte do nome, código interno ou código EAN do produto.
      </p>

      <div class="flex flex-col gap-3">
        <p-iconField iconPosition="left">
          <p-inputIcon styleClass="pi pi-search" />
          <input pInputText type="text" [(ngModel)]="searchTerm" (keydown.enter)="search()"
            placeholder="Pesquise por Nome, Código GSF ou Código de Barras" class="w-full" />
        </p-iconField>

        <div class="flex gap-2">
          <p-button label="Buscar" icon="pi pi-search" (onClick)="search()" [loading]="isProcessing"
            [disabled]="totalFilesLoaded === 0">
          </p-button>

          <p-button label="Limpar Tudo" icon="pi pi-trash" severity="secondary" (onClick)="clear()"
            [disabled]="totalFilesLoaded === 0">
          </p-button>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Results Table -->
  <p-card header="Resultados da Busca" *ngIf="hasResults || isProcessing" styleClass="mt-4">
    <p-table [value]="isProcessing ? skeletonRows : results" [paginator]="!isProcessing" [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]" styleClass="p-datatable-striped">
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="productName">
            Produto <p-sortIcon field="productName" *ngIf="!isProcessing"></p-sortIcon>
          </th>
          <th pSortableColumn="productCode">
            Cód. GSF/EAN <p-sortIcon field="productCode" *ngIf="!isProcessing"></p-sortIcon>
          </th>
          <th pSortableColumn="quantity">
            Qtd. <p-sortIcon field="quantity" *ngIf="!isProcessing"></p-sortIcon>
          </th>
          <th pSortableColumn="unit">
            Unidade <p-sortIcon field="unit" *ngIf="!isProcessing"></p-sortIcon>
          </th>
          <th pSortableColumn="fileName">
            Arquivo/Cupom <p-sortIcon field="fileName" *ngIf="!isProcessing"></p-sortIcon>
          </th>
          <th class="w-[4rem]"></th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-result>
        <tr *ngIf="!isProcessing">
          <td>
            <span class="font-bold">{{ result.productName }}</span>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <span *ngIf="result.productCode"
                class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-blue-400 w-fit">
                GSF: {{ result.productCode }}
              </span>
              <span *ngIf="result.ean && result.ean !== 'SEM GTIN'" class="text-xs text-gray-500">
                <i class="pi pi-barcode mr-1"></i>{{ result.ean }}
              </span>
            </div>
          </td>
          <td class="text-right font-mono text-lg">
            {{ formatDecimal(result.quantity) }}
          </td>
          <td>{{ result.unit }}</td>
          <td class="text-sm text-gray-500">{{ result.fileName }}</td>
          <td>
            <p-button icon="pi pi-file-pdf" [text]="true" [rounded]="true" pTooltip="Visualizar DANFE"
              tooltipPosition="left" (onClick)="openDanfe(result.fileName)"></p-button>
          </td>
        </tr>
        <tr *ngIf="isProcessing">
          <td><p-skeleton width="80%"></p-skeleton></td>
          <td><p-skeleton width="60%"></p-skeleton></td>
          <td><p-skeleton width="40%" styleClass="ml-auto"></p-skeleton></td>
          <td><p-skeleton width="30%"></p-skeleton></td>
          <td><p-skeleton width="50%"></p-skeleton></td>
          <td><p-skeleton shape="circle" size="2rem"></p-skeleton></td>
        </tr>
      </ng-template>
      <ng-template pTemplate="footer" *ngIf="!isProcessing">
        <tr>
          <td colspan="6" class="text-right">
            Total de Ocorrências: <strong>{{ results.length }}</strong> | Quantidade Total: <strong>{{
              formatDecimal(totalQuantity) }}</strong>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <app-danfe-modal [visible]="showDanfe" [nfeData]="currentNfeData" (visibleChange)="showDanfe = $event">
  </app-danfe-modal>
</div>
