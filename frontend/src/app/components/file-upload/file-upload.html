<!-- Toast (notificações) -->
<p-toast></p-toast>

<div class="flex justify-center p-4">
  <!-- Aumentei maxWidth para 80rem para evitar scroll horizontal -->
  <p-card header="Processamento de Arquivos" [style]="{ width: '100%', maxWidth: '80rem' }" styleClass="shadow-xl">

    <div class="flex flex-col items-center w-full">

      <!-- Seletor de Modo: Escolha entre ZIP único ou múltiplos XMLs -->
      <div class="mb-8 w-full flex justify-center">
        <p-selectButton [options]="modeOptions" [(ngModel)]="uploadMode" (onChange)="onModeChange()" optionLabel="label"
          optionValue="value" styleClass="w-full sm:w-auto">
          <ng-template let-item pTemplate="item">
            <div [pTooltip]="item.desc" tooltipPosition="bottom"
              class="flex flex-col items-center justify-center p-2 w-full h-full">
              <span>{{ item.label }}</span>
            </div>
          </ng-template>
        </p-selectButton>
      </div>

      <!-- Área de Upload de Arquivos -->
      <div class="w-full">
        <!--
          Configuração do componente p-fileUpload:
          mode="advanced": Permite templates personalizados
          customUpload="true": Usamos nossa própria lógica de envio (myUploader)
          showUploadButton/showCancelButton="false": Escondemos os nativos para usar os nossos no header
          [multiple]="true": Sempre true para garantir que o drag'n'drop aceite múltiplos.
                              O controle de quantidade é feito via [fileLimit].
        -->
        <p-fileUpload #fileUpload mode="advanced" [name]="'myfile[]'" [customUpload]="true"
          (uploadHandler)="myUploader($event)" (onError)="onUploadError($event)" [multiple]="true"
          [accept]="uploadMode === 'zip' ? '.zip' : '.xml'" [maxFileSize]="50000000"
          [fileLimit]="uploadMode === 'zip' ? 1 : 1000" [showUploadButton]="false" [showCancelButton]="false"
          invalidFileSizeMessageSummary="Arquivo muito grande" invalidFileSizeMessageDetail="O tamanho máximo é {0}."
          styleClass="w-full">

          <!--
             TEMPLATE DO CABEÇALHO
             Personalizado para centralizar os botões Escolher, Processar e Limpar.
          -->
          <ng-template pTemplate="header" let-files let-chooseCallback="chooseCallback"
            let-clearCallback="clearCallback" let-uploadCallback="uploadCallback">
            <div class="flex flex-wrap justify-center gap-4 py-4 border-b border-surface-200 dark:border-surface-700">
              <p-button (onClick)="chooseCallback()" icon="pi pi-plus" label="Escolher" [outlined]="true"
                [disabled]="isUploading"></p-button>
              <p-button (onClick)="uploadCallback()" icon="pi pi-cloud-upload" label="Processar" severity="success"
                [disabled]="!files || files.length === 0 || isUploading"></p-button>
              <p-button (onClick)="clearCallback()" icon="pi pi-times" label="Limpar" severity="danger"
                [outlined]="true" [disabled]="!files || files.length === 0 || isUploading"></p-button>
            </div>
          </ng-template>

          <!--
             TEMPLATE DE CONTEÚDO (CORPO)
             Gerencia o que é exibido dentro da área principal de upload.
             Tem 3 estados principais:
             1. Enviando (isUploading): Mostra Knob de progresso.
             2. Arquivos Selecionados: Mostra lista customizada.
             3. Vazio: Mostra área de drop/seleção.
          -->
          <ng-template pTemplate="content">

            <!-- ESTADO 1: ENVIANDO/PROCESSANDO -->
            @if (isUploading) {
            <div class="flex flex-col items-center justify-center p-8">
              <!-- Knob visual para progresso (0-100) -->
              <p-knob [(ngModel)]="progress" [readonly]="true" [size]="150" valueColor="#5d8a8c"
                rangeColor="#f3e4c9"></p-knob>
              <span class="mt-4 text-primary font-semibold text-lg">Processando...</span>
            </div>

            <!-- ESTADO 2: ARQUIVOS JÁ SELECIONADOS -->
            } @else if (fileUpload.files.length > 0) {
            <div class="flex flex-col gap-4 p-4">

              <!-- RESUMO DA SELEÇÃO (Padrão) -->
              <div
                class="flex flex-col sm:flex-row items-center justify-between p-4 bg-surface-50 dark:bg-surface-800 rounded-lg border surface-border gap-4">
                <div class="flex flex-col items-center sm:items-start text-center sm:text-left">
                  <span class="font-bold text-xl">{{ fileUpload.files.length }} arquivos selecionados</span>
                  <span class="text-sm text-gray-500">Tamanho total: {{ totalSize }}</span>

                  <!-- Exibir nome do arquivo ZIP se for upload único -->
                  @if (uploadMode === 'zip' && fileUpload.files[0]) {
                  <span class="text-primary font-semibold mt-1">{{ fileUpload.files[0].name }}</span>
                  }
                </div>

                <!-- Botão de "Ver Todos" (Escondido se for ZIP) -->
                @if (uploadMode !== 'zip') {
                <div class="flex gap-2">
                  <p-button [label]="showFileList ? 'Ocultar Detalhes' : 'Ver Todos'"
                    [icon]="showFileList ? 'pi pi-eye-slash' : 'pi pi-eye'" [outlined]="true"
                    (onClick)="toggleFileList()"></p-button>
                </div>
                }
              </div>

              <!-- LISTA DE ARQUIVOS (Virtual Scroll + Pesquisa) -->
              <!-- Só renderiza se showFileList for true e NÃO for ZIP -->
              @if (showFileList && uploadMode !== 'zip') {

              <!-- BARRA DE PESQUISA -->
              <div class="flex justify-center mb-2">
                <p-iconField iconPosition="left" class="w-full">
                  <p-inputIcon styleClass="pi pi-search" />
                  <input type="text" pInputText placeholder="Pesquisar arquivo..." [(ngModel)]="searchTerm"
                    class="w-full" />
                </p-iconField>
              </div>

              <!--
                   Usamos p-scroller para renderizar apenas os itens visíveis.
                   scrollHeight="400px": Altura máxima do container com scroll.
                   itemSize="80": Altura fixa de cada linha (px) para cálculo do scroll.
                -->
              <p-scroller [items]="filteredFiles" [itemSize]="80" scrollHeight="400px"
                styleClass="border surface-border rounded-lg" [style]="{'width': '100%'}">
                <ng-template pTemplate="item" let-file let-options="options">
                  <div
                    class="flex items-center justify-between p-3 border-b surface-border hover:bg-surface-50 dark:hover:bg-surface-700 transition-colors h-[80px]">
                    <!-- min-w-0 é CRÍTICO para o truncate funcionar dentro do flex -->
                    <div class="flex items-center gap-3 overflow-hidden min-w-0 flex-1">
                      <i class="pi pi-file text-2xl text-primary flex-shrink-0"></i>
                      <div class="flex flex-col overflow-hidden min-w-0">
                        <!-- USANDO INNERHTML PARA O HIGHLIGHT -->
                        <span class="font-semibold truncate block" [title]="file.name"
                          [innerHTML]="file.name | highlight: searchTerm"></span>
                        <span class="text-sm text-gray-500 flex-shrink-0">{{fileUpload.formatSize(file.size)}}</span>
                      </div>
                    </div>

                    <!-- Botão de remover: Usa removeFile passando o OBJETO file, pois o index do scroller pode não bater com o original se filtrado -->
                    <p-button icon="pi pi-times" [text]="true" severity="danger" class="flex-shrink-0 ml-2"
                      (onClick)="removeFile($event, file)"></p-button>
                  </div>
                </ng-template>
              </p-scroller>
              }

            </div>

            <!-- ESTADO 3: VAZIO / ESTADO INICIAL -->
            } @else {
            <div class="flex flex-col items-center justify-center py-10 text-center cursor-pointer"
              (click)="fileUpload.choose()">
              <i class="pi pi-cloud-upload text-6xl text-primary mb-4 opacity-50"></i>
              <p class="text-lg font-semibold text-gray-600">Arraste e solte arquivos aqui ou clique para selecionar</p>
              <p class="text-sm text-gray-500 mt-2">
                @if (uploadMode === 'zip') {
                Suporta apenas arquivos .zip
                } @else {
                Suporta múltiplos arquivos .xml
                }
              </p>
            </div>
            }
          </ng-template>

        </p-fileUpload>
      </div>

    </div>
  </p-card>
</div>

<!-- Dialog de Resumo do Processamento -->
<p-dialog header="Resumo do Processamento" [(visible)]="showSummaryDialog" [modal]="true" [style]="{width: '50vw'}"
  [draggable]="false" [resizable]="false">

  <div class="flex flex-col gap-6 py-4">

    <div class="text-center text-gray-900 font-bold text-lg">
      O seu arquivo processado foi descarregado automaticamente.
      <br>Abaixo estão os detalhes do pacote:
    </div>

    <!-- Gráfico de Rosca -->
    <div class="flex justify-center w-full">
        <p-chart type="doughnut" [data]="chartData" [options]="chartOptions" width="300px" height="300px"></p-chart>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <!-- Card Aprovados (Solid Green) -->
      <div
        class="flex flex-col items-center p-6 bg-green-600 dark:bg-green-700 rounded-xl shadow-lg transform transition-transform hover:scale-105 text-center">
        <i class="pi pi-check-circle text-5xl text-white mb-3"></i>
        <span class="text-5xl font-extrabold text-white tracking-tight">{{ processingSummary.approved }}</span>
        <span class="text-sm font-bold text-green-100 uppercase tracking-widest mt-2 mb-4">Aprovados</span>

        <div class="flex flex-col gap-1 w-full border-t border-green-500/50 pt-3">
            <div class="flex justify-between text-green-50 text-sm">
                <span>Total:</span>
                <span class="font-bold">{{ processingSummary.approvedValue | currency:'BRL' }}</span>
            </div>
            <div class="flex justify-between text-green-200 text-xs">
                <span>ICMS:</span>
                <span>{{ processingSummary.approvedIcms | currency:'BRL' }}</span>
            </div>
        </div>
      </div>

      <!-- Card Contingência (Solid Orange) -->
      <div
        class="flex flex-col items-center p-6 bg-orange-500 dark:bg-orange-600 rounded-xl shadow-lg transform transition-transform hover:scale-105 text-center">
        <i class="pi pi-exclamation-triangle text-5xl text-white mb-3"></i>
        <span class="text-5xl font-extrabold text-white tracking-tight">{{ processingSummary.contingency }}</span>
        <span class="text-sm font-bold text-orange-100 uppercase tracking-widest mt-2 mb-4">Contingência</span>

        <div class="flex flex-col gap-1 w-full border-t border-orange-400/50 pt-3">
            <div class="flex justify-between text-orange-50 text-sm">
                <span>Total:</span>
                <span class="font-bold">{{ processingSummary.contingencyValue | currency:'BRL' }}</span>
            </div>
            <div class="flex justify-between text-orange-200 text-xs">
                <span>ICMS:</span>
                <span>{{ processingSummary.contingencyIcms | currency:'BRL' }}</span>
            </div>
        </div>
      </div>

      <!-- Card Rejeitados (Solid Red) -->
      <div
        class="flex flex-col items-center p-6 bg-red-600 dark:bg-red-700 rounded-xl shadow-lg transform transition-transform hover:scale-105 text-center">
        <i class="pi pi-times-circle text-5xl text-white mb-3"></i>
        <span class="text-5xl font-extrabold text-white tracking-tight">{{ processingSummary.rejected }}</span>
        <span class="text-sm font-bold text-red-100 uppercase tracking-widest mt-2 mb-4">Rejeitados</span>

        <div class="flex flex-col gap-1 w-full border-t border-red-500/50 pt-3">
            <div class="flex justify-between text-red-50 text-sm">
                <span>Total:</span>
                <span class="font-bold">{{ processingSummary.rejectedValue | currency:'BRL' }}</span>
            </div>
            <div class="flex justify-between text-red-200 text-xs">
                <span>ICMS:</span>
                <span>{{ processingSummary.rejectedIcms | currency:'BRL' }}</span>
            </div>
        </div>
      </div>
    </div>

    @if (processingSummary.rejected > 0) {
    <div
      class="flex items-center gap-4 p-4 bg-red-50 dark:bg-red-900/20 border-2 border-red-600 dark:border-red-500 text-red-900 dark:text-white rounded-xl shadow-md mt-4">
      <div class="p-2 bg-red-600 rounded-full text-white">
        <i class="pi pi-info-circle text-xl"></i>
      </div>
      <div>
        <span class="block font-extrabold text-xl text-red-950">Atenção Necessária</span>
        <span class="font-bold text-red-900">Um relatório detalhado de erros foi gerado: <strong
            class="text-black underline">relatorio_erros.csv</strong>. Verifique a pasta 'rejeitados'.</span>
      </div>
    </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <p-button icon="pi pi-check" (click)="showSummaryDialog = false" label="Fechar"
      styleClass="p-button-text"></p-button>
  </ng-template>
</p-dialog>
